<%- include("layout", { title: movie.title, user: user }) %>

<section class="movie-page">
  <div class="player">
    <% 
      const url = movie.videoUrl || "";
      const isYouTube = url.includes("youtube.com") || url.includes("youtu.be");
      const isArchiveEmbed = url.includes("archive.org/embed");
      const isMP4 = url.endsWith(".mp4");
    %>

    <% if (isYouTube) { %>
      <!-- üé• YouTube Embed -->
      <iframe
        width="100%"
        height="500"
        src="<%= url.includes('embed') ? url : url.replace('watch?v=', 'embed/') %>"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen>
      </iframe>

    <% } else if (isArchiveEmbed) { %>
      <!-- üéû Internet Archive Player -->
      <iframe
        width="100%"
        height="500"
        src="<%= url %>"
        frameborder="0"
        allow="autoplay; fullscreen"
        allowfullscreen>
      </iframe>

    <% } else if (isMP4) { %>
      <!-- üé¨ Direct MP4 Video -->
      <video id="moviePlayer" controls width="100%" height="500" preload="metadata">
        <source src="<%= url %>" type="video/mp4">
        Your browser does not support the video tag.
      </video>

    <% } else { %>
      <!-- ‚ö†Ô∏è Unsupported -->
      <div style="padding: 60px 20px; text-align: center; background: rgba(229, 9, 20, 0.1);">
        <p style="color:#ff6b6b; font-size: 1.2rem;">‚ö†Ô∏è Unsupported video format or invalid URL</p>
      </div>
    <% } %>
  </div>

  <div class="meta">
    <h2><%= movie.title %></h2>
    <p class="muted" style="font-size: 1.1rem; margin-bottom: 24px;">
      <%= movie.genre %> ‚Ä¢ <%= movie.releaseYear %><% if (movie.rating) { %> ‚Ä¢ ‚≠ê <%= movie.rating %>/10<% } %>
    </p>
    <p style="line-height: 1.8; margin-bottom: 24px;"><%= movie.description %></p>
    
    <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 24px;">
      <a class="btn" href="/favorites/add/<%= movie._id %>">‚ù§Ô∏è Add to Favorites</a>
      <form method="POST" action="/movies/<%= movie._id %>/party" style="display:inline">
        <button class="btn" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);">
          üéâ Start Watch Party
        </button>
      </form>
    </div>
  </div>
</section>

<!-- üìú Auto Add to Watch History Script -->
<script>
  const movieId = "<%= movie._id %>";
  let historyAdded = false;

  function addToHistory() {
    if (historyAdded) return; // Prevent duplicate adds
    historyAdded = true;
    
    fetch(`/history/add/${movieId}`, { 
      method: "GET",
      credentials: "same-origin" 
    })
    .then(res => {
      if (res.ok) {
        console.log("‚úÖ Automatically added to watch history");
      }
    })
    .catch(err => console.error("‚ùå History add failed", err));
  }

  // For direct MP4 player
  const video = document.getElementById("moviePlayer");
  if (video) {
    let watchTimer;
    let hasPlayed = false;
    
    video.addEventListener("play", () => {
      if (!hasPlayed) {
        hasPlayed = true;
        clearTimeout(watchTimer);
        // Add to history after 30 seconds of watching
        watchTimer = setTimeout(addToHistory, 30000);
      }
    });
    
    video.addEventListener("pause", () => {
      clearTimeout(watchTimer);
    });
  }

  // For embedded iframes (Archive.org / YouTube)
  const iframe = document.querySelector("iframe");
  if (iframe && !video) {
    // Add to history after 1 minute for embedded videos
    setTimeout(addToHistory, 60000);
  }
</script>

<%- include("footer") %>
